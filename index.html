<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>연금복권720+ 빈도 기반 추천기</title>
  <style>
    :root{
      --bg:#0b1020; --card:#121a33; --card2:#0f1730;
      --text:#e9eeff; --muted:#aab4de; --line:#24305f;
      --accent:#7aa2ff; --good:#35d399; --warn:#ffd166;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --r:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif;
      background: radial-gradient(1200px 700px at 20% 0%, #15204a 0%, var(--bg) 50%, #070a14 100%);
      color:var(--text);
    }
    a{color:var(--accent); text-decoration:none}
    .wrap{max-width:980px; margin:0 auto; padding:20px}
    header{
      display:flex; gap:14px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;
      padding:18px 18px 14px; border:1px solid var(--line); border-radius:var(--r);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
    }
    .title{display:flex; flex-direction:column; gap:6px}
    .title h1{margin:0; font-size:18px; letter-spacing:-.2px}
    .sub{margin:0; color:var(--muted); font-size:13px; line-height:1.35}
    .meta{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end}
    .pill{
      font-size:12px; color:var(--muted);
      padding:8px 10px; border:1px solid var(--line); border-radius:999px;
      background: rgba(0,0,0,.18);
    }

    .panel{
      margin-top:14px;
      display:grid; gap:12px;
      grid-template-columns: 1fr;
    }
    .card{
      border:1px solid var(--line); border-radius:var(--r);
      background: rgba(18,26,51,.65);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:14px 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,0));
      border-bottom:1px solid rgba(36,48,95,.55);
    }
    .card .hd b{font-size:14px}
    .card .bd{padding:14px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

    .btns{display:flex; gap:10px; flex-wrap:wrap}
    button{
      cursor:pointer; border:1px solid rgba(122,162,255,.35);
      background: rgba(122,162,255,.12);
      color:var(--text);
      padding:10px 12px; border-radius:12px; font-weight:700; font-size:13px;
      transition: transform .06s ease, background .2s ease;
    }
    button:active{transform: scale(.98)}
    button.secondary{
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color:var(--muted);
      font-weight:600;
    }

    .grid{
      display:grid; gap:10px;
      grid-template-columns: repeat(1, 1fr);
    }
    @media (min-width: 720px){
      .grid{grid-template-columns: repeat(2, 1fr);}
    }

    .ticket{
      padding:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius:14px;
      display:flex; flex-direction:column; gap:8px;
    }
    .topline{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .left{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .group{
      min-width:52px;
      display:inline-flex; align-items:center; justify-content:center;
      padding:8px 10px; border-radius:999px;
      font-weight:900; font-size:13px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
    }
    .mode{
      font-size:12px; color:var(--muted);
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
    }
    .balls{display:flex; gap:6px; align-items:center; flex-wrap:wrap}
    .ball{
      width:34px; height:34px; border-radius:999px;
      display:inline-flex; align-items:center; justify-content:center;
      font-weight:900; font-size:15px;
      border:1px solid rgba(255,255,255,.14);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.18);
      user-select:none;
    }
    .ball.roll{animation: pop .35s ease both}
    @keyframes pop{
      0%{transform:translateY(2px) scale(.98); filter:brightness(.95)}
      60%{transform:translateY(-1px) scale(1.03); filter:brightness(1.12)}
      100%{transform:translateY(0) scale(1); filter:brightness(1)}
    }

    /* digit color (0~9) */
    .d0{background:#2dd4bf1f; color:#bff7ef}
    .d1{background:#60a5fa22; color:#cfe5ff}
    .d2{background:#a78bfa22; color:#eadcff}
    .d3{background:#fb718522; color:#ffe0e6}
    .d4{background:#fbbf2422; color:#fff1cc}
    .d5{background:#34d39922; color:#d7ffef}
    .d6{background:#22c55e22; color:#d5ffe4}
    .d7{background:#f9731622; color:#ffe4d1}
    .d8{background:#e879f922; color:#ffe3ff}
    .d9{background:#94a3b822; color:#edf2ff}

    /* group color (1~5) */
    .g1{background:rgba(96,165,250,.16); color:#d8ecff}
    .g2{background:rgba(167,139,250,.16); color:#f1e9ff}
    .g3{background:rgba(251,113,133,.16); color:#ffe3ea}
    .g4{background:rgba(251,191,36,.16); color:#fff0c9}
    .g5{background:rgba(52,211,153,.16); color:#d9fff0}

    .hintline{
      font-size:12px; color:var(--muted); line-height:1.35;
      padding:9px 10px;
      border:1px dashed rgba(255,255,255,.12);
      border-radius:12px;
      background: rgba(0,0,0,.14);
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    }
    .hintline b{color:#dce5ff}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace}

    .note{
      margin-top:10px;
      font-size:12px; color:var(--muted); line-height:1.45;
      padding:10px 12px; border:1px dashed rgba(255,255,255,.16);
      border-radius:12px; background: rgba(0,0,0,.15);
    }
    .err{
      padding:12px; border-radius:14px;
      border:1px solid rgba(255,209,102,.35);
      background: rgba(255,209,102,.12);
      color:#ffe9b7;
      line-height:1.45;
      font-size:13px;
      white-space:pre-wrap;
    }
    .small{font-size:12px; color:var(--muted)}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>연금복권720+ 빈도 기반 추천기</h1>
        <p class="sub">
          <b>무작위 없이</b>도 “수백만 조합”까지 크게 순환합니다. (기기별 시드 + cycle 분산)
        </p>
      </div>
      <div class="meta">
        <div class="pill" id="pill-round">회차: -</div>
        <div class="pill" id="pill-updated">업데이트: -</div>
        <div class="pill" id="pill-seed">시드: -</div>
        <a class="pill" href="https://www.dhlottery.co.kr/pt720/intro" target="_blank" rel="noopener">공식 안내</a>
      </div>
    </header>

    <div class="panel">
      <section class="card">
        <div class="hd">
          <b>추천 생성</b>
          <span class="small">1/5/10 모두 클릭할수록 “큰 순환”으로 변합니다(무작위 X)</span>
        </div>
        <div class="bd">
          <div class="row">
            <div class="btns">
              <button id="b1">번호 1개 추천</button>
              <button id="b5">번호 5개 추천</button>
              <button id="b10">번호 10개 추천</button>
              <button class="secondary" id="bReset">사이클 리셋</button>
              <button class="secondary" id="bSeedReset">시드 초기화</button>
            </div>
          </div>
          <div class="note">
            ※ 2등은 <b>조만 바뀌고 6자리는 동일</b> / 3등은 <b>끝 5자리 일치</b> 조건이라, 추천 결과에 <b>2등·3등 힌트</b>를 같이 보여줍니다.<br/>
            ※ 여러 사람이 눌러도 같은 번호가 덜 겹치도록 <b>기기별(브라우저별) 시드</b>를 기본으로 씁니다.
          </div>
        </div>
      </section>

      <section class="card">
        <div class="hd">
          <b>추천 결과</b>
          <span class="small" id="status">데이터 로딩 중…</span>
        </div>
        <div class="bd">
          <div id="out" class="grid"></div>
          <div id="err" class="err" style="display:none;"></div>
        </div>
      </section>
    </div>
  </div>

<script>
  // ✅ 프로젝트 루트 기준 경로 고정
  const PROJECT_ROOT = location.pathname.includes("/yeongeum720/")
    ? new URL("../", location.href)
    : new URL("./", location.href);

  const PATH_FREQ  = new URL("data/yeongeum720_freq.json", PROJECT_ROOT).toString();
  const PATH_DRAWS = new URL("data/yeongeum720_draws.json", PROJECT_ROOT).toString(); // (현재 UI에선 미사용)

  let freq = null;

  const $ = (sel) => document.querySelector(sel);
  const cacheBust = (url) => url + (url.includes("?") ? "&" : "?") + "v=" + Date.now();

  function setText(id, t){ $(id).textContent = t; }

  function readCycle(key){
    const v = localStorage.getItem(key);
    const n = v ? parseInt(v, 10) : 0;
    return Number.isFinite(n) ? n : 0;
  }
  function writeCycle(key, n){
    localStorage.setItem(key, String(n));
  }

  // ─────────────────────────────────────────────────────────
  // ✅ 무작위 없이도 “큰 순환”을 만들기 위한 해시/믹스(결정론)
  function fnv1a32(str){
    let h = 0x811c9dc5;
    for (let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 0x01000193);
    }
    return (h >>> 0);
  }

  function mix32(x){
    x >>>= 0;
    x ^= x >>> 16;
    x = Math.imul(x, 0x7feb352d) >>> 0;
    x ^= x >>> 15;
    x = Math.imul(x, 0x846ca68b) >>> 0;
    x ^= x >>> 16;
    return x >>> 0;
  }

  function getSeed32(){
    // 사용자가 저장한 seed가 있으면 그걸 우선
    const saved = localStorage.getItem("yeongeum720_seed");
    if (saved && saved.trim()) return fnv1a32(saved.trim());

    // 기본은 “기기/브라우저별로” 조금씩 다르게(여러 사람 동일 번호 겹침 완화)
    const base = [
      location.host,
      location.pathname.split("/").slice(0,3).join("/"),
      navigator.userAgent,
      navigator.language || ""
    ].join("|");

    return fnv1a32(base);
  }

  function toHex8(u32){
    return (u32 >>> 0).toString(16).padStart(8, "0");
  }

  function ranksFromFreq(freq){
    const groupRank = (freq.group?.ranked || []).map(x => x.digit);
    const posRank = (freq.positions || []).map(p => (p.ranked || []).map(x => x.digit));
    return { groupRank, posRank };
  }

  function makeHints(group, digits){
    const number = digits.join("");
    const last5 = number.slice(1);
    const secondGroups = [1,2,3,4,5].filter(g => g !== group);
    return { number, last5, secondGroups };
  }

  // ─────────────────────────────────────────────────────────
  // ✅ “빈도 기반” 유지: posRank[p][rankIndex]에서 rankIndex만 크게 순환
  // mode별로 “랭크대”만 다르게:
  // 1개: 상위偏(대부분 상위, 가끔 중위까지)
  // 5개: 상위~중위 혼합
  // 10개: 상~중~하 분산(훨씬 넓게)
  const BANDS_1  = [[0,6]]; // 0~5 (상위偏)
  const BANDS_5  = [[0,7],[0,8],[1,9],[2,10],[0,10]]; // 상위~중위, 마지막은 와이드
  const BANDS_10 = [
    [0,4],[0,5],[1,6],     // 상
    [2,7],[3,8],[4,9],     // 중
    [5,10],[6,10],[0,10],  // 하/와이드
    [0,10]                 // 와이드
  ];

  function pickBand(mode, slot){
    if (mode === 1) return BANDS_1[0];
    if (mode === 5) return BANDS_5[slot % BANDS_5.length];
    return BANDS_10[slot % BANDS_10.length];
  }

  function makeTicket(mode, cycle, slot){
    const seed = getSeed32();
    const maxRound = freq?.rounds?.max ?? 0;

    const { groupRank, posRank } = ranksFromFreq(freq);
    const gLen = groupRank.length || 5;

    const band = pickBand(mode, slot);
    const start = band[0], end = band[1];
    const span = Math.max(1, end - start);

    // 그룹 선택: cycle/slot/seed/회차를 섞어서 분산
    const gx = mix32(seed ^ Math.imul(maxRound + 1, 0x9e3779b1) ^ Math.imul(cycle + 7, 0x85ebca6b) ^ Math.imul(slot + 13, 0xc2b2ae35) ^ Math.imul(mode, 0x27d4eb2f));
    const group = groupRank[gx % gLen] ?? ((gx % 5) + 1);

    // 6자리: 각 자리마다 서로 다른 salt로 큰 순환
    const digits = [];
    for (let p=0; p<6; p++){
      const r = posRank[p] || [0,1,2,3,4,5,6,7,8,9];

      // 결정론적 인덱스 (무작위 X)
      let x = seed;
      x ^= Math.imul(maxRound + 11, 0x9e3779b1);
      x ^= Math.imul(cycle + 31, 0x85ebca6b);
      x ^= Math.imul(slot + 97, 0xc2b2ae35);
      x ^= Math.imul(p + 1, 0x27d4eb2f);
      x ^= Math.imul(mode, 0x165667b1);
      x = mix32(x);

      // mode별 band 범위 안에서 rankIndex 선택
      const rankIndex = start + (x % span);
      digits.push(r[rankIndex % r.length] ?? r[0] ?? 0);
    }

    return { group, digits, ...makeHints(group, digits) };
  }

  function makeBatch(mode, count, cycle){
    const out = [];
    const used = new Set();

    for (let i=0;i<count;i++){
      // 중복이 나오면 slot을 살짝 이동시키며(결정론적으로) 다시 생성
      let saltTry = 0;
      let ticket;
      while (true){
        ticket = makeTicket(mode, cycle, i + saltTry * 100);
        const key = `${ticket.group}-${ticket.number}`;
        if (!used.has(key)) {
          used.add(key);
          break;
        }
        saltTry++;
        if (saltTry > 20) break; // 과한 루프 방지
      }

      const modeLabel =
        mode === 1  ? "1개(상위偏·대형순환)" :
        mode === 5  ? "5개(상~중 혼합·대형순환)" :
                      "10개(상~중~하 분산·대형순환)";

      out.push({
        label: String(i + 1),
        mode: modeLabel,
        ...ticket
      });
    }
    return out;
  }

  // ─────────────────────────────────────────────────────────
  function ballEl(d, delayMs=0){
    const s = document.createElement("span");
    s.className = "ball d" + d + " roll";
    s.style.animationDelay = delayMs + "ms";
    s.textContent = String(d);
    return s;
  }

  function ticketEl(t){
    const card = document.createElement("div");
    card.className = "ticket";

    const topline = document.createElement("div");
    topline.className = "topline";

    const left = document.createElement("div");
    left.className = "left";

    const g = document.createElement("span");
    g.className = "group g" + t.group;
    g.textContent = t.group + "조";

    const balls = document.createElement("div");
    balls.className = "balls";

    t.digits.forEach((d, i)=>{
      balls.appendChild(ballEl(d, i * 35));
    });

    left.appendChild(g);
    left.appendChild(balls);

    const right = document.createElement("span");
    right.className = "mode";
    right.textContent = t.mode;

    topline.appendChild(left);
    topline.appendChild(right);

    const h = document.createElement("div");
    h.className = "hintline";
    const secondText = t.secondGroups.map(g => `${g}조`).join(", ");
    h.innerHTML = `
      <span><b>2등(조만 변경):</b> <span class="mono">${secondText} + ${t.number}</span></span>
      <span>│</span>
      <span><b>3등(끝 5자리):</b> <span class="mono">${t.last5}</span></span>
    `;

    card.appendChild(topline);
    card.appendChild(h);
    return card;
  }

  function render(list){
    const out = $("#out");
    out.innerHTML = "";
    list.forEach((t)=> out.appendChild(ticketEl(t)));
  }

  async function load(){
    try{
      const res = await fetch(cacheBust(PATH_FREQ));
      if(!res.ok) throw new Error(`freq fetch failed: ${res.status} ${res.statusText}\nURL: ${PATH_FREQ}`);

      freq = await res.json();

      const maxRound = freq.rounds?.max ?? "-";
      setText("#pill-round", "회차: " + maxRound);
      setText("#pill-updated", "업데이트: " + (freq.updatedAt ? freq.updatedAt.replace("T"," ").replace("Z"," UTC") : "-"));

      const seed = getSeed32();
      setText("#pill-seed", "시드: " + toHex8(seed));

      setText("#status", "준비 완료");
    }catch(e){
      $("#err").style.display = "block";
      $("#err").textContent =
        "데이터 로딩 실패\n\n" +
        "- Actions에서 data/*.json이 생성/커밋됐는지 확인하세요.\n" +
        "- 에러: " + (e?.message || e);
      setText("#status", "오류");
    }
  }

  $("#b1").addEventListener("click", ()=>{
    if(!freq) return;
    const k = "yeongeum720_cycle_1";
    const cycle = readCycle(k) + 1;
    writeCycle(k, cycle);
    render(makeBatch(1, 1, cycle));
  });

  $("#b5").addEventListener("click", ()=>{
    if(!freq) return;
    const k = "yeongeum720_cycle_5";
    const cycle = readCycle(k) + 1;
    writeCycle(k, cycle);
    render(makeBatch(5, 5, cycle));
  });

  $("#b10").addEventListener("click", ()=>{
    if(!freq) return;
    const k = "yeongeum720_cycle_10";
    const cycle = readCycle(k) + 1;
    writeCycle(k, cycle);
    render(makeBatch(10, 10, cycle));
  });

  $("#bReset").addEventListener("click", ()=>{
    ["yeongeum720_cycle_1","yeongeum720_cycle_5","yeongeum720_cycle_10"]
      .forEach(k => localStorage.removeItem(k));
    setText("#status", "사이클 리셋 완료");
  });

  $("#bSeedReset").addEventListener("click", ()=>{
    localStorage.removeItem("yeongeum720_seed");
    setText("#status", "시드 초기화 완료(기기 시드 적용)");
    setText("#pill-seed", "시드: " + toHex8(getSeed32()));
  });

  load();
</script>
</body>
</html>
