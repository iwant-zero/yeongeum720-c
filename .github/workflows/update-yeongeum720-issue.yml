name: Yeongeum720 Recommend (Issue)

on:
  workflow_dispatch:
  issues:
    types: [opened, edited]

permissions:
  issues: write
  contents: read

jobs:
  recommend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
      - uses: actions/checkout@v4

      - name: Setup Node
      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Build recommendation markdown
        id: rec
        run: |
          echo "body<<EOF" >> $GITHUB_OUTPUT
          node scripts/update_yeongeum720.mjs --no-write --recommend 10 >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment to issue
      - uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.payload.issue?.number;
            if (!issue_number) {
              core.info("No issue context (workflow_dispatch). Skip commenting.");
              return;
            }
            const body = `${{ toJSON(steps.rec.outputs.body) }}`;
            // toJSON으로 감싸면 문자열 따옴표가 붙으니 처리
            const cleaned = JSON.parse(body);

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
              body: cleaned
            });
